# System Architecture & Scientific Provenance

**Usage:** This document is the "Context Map" for any AI Agent working on this codebase. Read this first to understand *where* the numbers come from.

## 1. The Science Engine (Core Logic)

The "Brain" of the application is **Physics-Based**, not a black box. It translates satellite light (Reflectance) into biological traits (Chlorophyll, Nitrogen, Vmax).

-   **Core Library**: `lib/cropModels.ts`
    -   Contains the final equations: `Trait = Slope * Reflectance + Intercept`.
    -   Equations are **Species-Aware** (Corn, Soybean, Wheat).
    -   **DO NOT EDIT** coefficients manually. They are generated by the calibration scripts.

-   **Weight File**: `crop_model_weights.json`
    -   Stores the Slope/Intercept/R2 values for every crop.
    -   Generated by: `scripts/calibrate_multi_crop.py`.

## 2. Data Sources (The "Truth")

Existing dataset files (Located in `C:\Users\gotok\Downloads` or `data/`):

1.  **Ground Truth** (Used for Corn Calibration):
    -   `Nitrogen.csv`: Leaf-level N% from UIUC/SoyFACE.
    -   `Chlorophyll.csv`: SPAD meter readings.
    -   `Vmax.csv`: Photosynthetic capacity.
2.  **Yield Benchmarks** (Used for Validation):
    -   `1_Training_Trait_Data_2014_2021.csv`: The **Genomes To Fields (G2F)** dataset.
    -   Used to set the "Regional Target Yield" (e.g., 11.2 Mg/ha).

## 3. Calibration Pipeline (How to Retrain)

If you need to improve accuracy or add a new crop, follow this flow:

1.  **Run Simulation**: `scripts/calibrate_multi_crop.py`
    -   Uses **PROSAIL RTM** (Radiative Transfer Model) to generate 10,000 synthetic plants.
    -   Simulates physics: `Light -> Leaf Structure -> Reflectance`.
2.  **Output**: Saves new weights to `crop_model_weights.json`.
3.  **Deploy**: `lib/cropModels.ts` automatically reads this JSON.

## 4. Feature Implementation Map

| Feature | Logic Location | Implementation Detail |
| :--- | :--- | :--- |
| **Nitrogen/Vmax** | `lib/cropModels.ts` | Linear Regression from Sentinel-2 Band 5 (705nm). |
| **CWSI (Drought)** | `actions/analyzeField.ts` | Formula: `(Tc - Ta - LL) / (UL - LL)`. Uses Landsat Thermal + Open-Meteo Air Temp. |
| **Radar RVI** | `actions/analyzeField.ts` | Formula: `4 * VH / (VV + VH)`. Detecs biomass structure/lodging. |
| **Satellite Fetch** | `actions/satellite.ts` | Fetches **7 Precision Bands** (Green, Red, RE1, RE2, RE3, NIR, NarrowNIR). |

## 5. Quick Reference for Agents

*   **"Where is the chemistry logic?"** -> `lib/cropModels.ts`
*   **"Where do I fix the thermal math?"** -> `actions/analyzeField.ts` (Search for `CWSI`)
*   **"Where is the satellite API?"** -> `actions/satellite.ts` (Sentinel Hub API)
*   **"Where did the Nitrogen data come from?"** -> It came from `Nitrogen.csv` (Illinois Data Bank), processed by `scripts/train_plsr_rtm.py`.
